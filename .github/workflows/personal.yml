name: Convert hagezi to mrs

on:
  schedule:
    - cron: "0 18 1/4 * *"
  push:
    paths:
      - 'personal/**'
    branches:
      - main
  workflow_dispatch:
  
permissions:
  contents: write

jobs:
  convert:
    runs-on: ubuntu-latest
    steps:
      - name: Set ENV
        run: |
          echo "RELEASE_NAME=$(date +%Y%m%d%H%M)" >> $GITHUB_ENV
        shell: bash

      - name: Install Depedencies
        run: |
          sudo apt update
          sudo apt install -y curl wget git jq
        shell: bash
         
      - name: Create folders
        run: |
          mkdir -p .output
          mkdir -p hagezi
        shell: bash

      - name: Download and install Mihomo
        run: |
          MIHOMO_BIN_URL=$(curl -s -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/MetaCubeX/mihomo/releases/latest | \
            jq -r '.assets[] | select(.name | test("mihomo-linux-amd64-v.*\\.deb$")) | .browser_download_url' | \
            head -n 1)
          wget -q -O ./.output/mihomo-linux-amd64.deb "$MIHOMO_BIN_URL"
          sudo apt install --fix-missing ./.output/mihomo-linux-amd64.deb
        shell: bash
        
      - name: Convert to mrs
        run: |
          find personal -type f -name sources.txt | while read source_file; do
            subdir=$(dirname "$source_file")
            dir_name=$(basename "$subdir")
            echo "Processing directory: $dir_name"
            
            temp_file=".output/${dir_name}_combined.tmp"
            > "$temp_file"
            
            while IFS= read -r url || [ -n "$url" ]; do
              echo "Downloading $url"
              wget -q -O - "$url" >> "$temp_file"
              printf "\n" >> "$temp_file"
            done < "$source_file"
            
            addition_file="${subdir}/addition.list"
            if [ -f "$addition_file" ]; then
              cat "$addition_file" >> "$temp_file"
            fi
            
            out_file="personal/${dir_name}.mrs"
            mihomo convert-ruleset domain text "$temp_file" "$out_file"
          done

      - name: Delete temp files
        run: |
          rm -rf .output
      
      - name: Push mrs assets to main branch
        run: |
          git init
          git config --local user.name "github-actions[bot]"
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git checkout -b personal
          git add personal/*.mrs
          git commit -m "${{ env.RELEASE_NAME }}"
          git remote add release "https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}"
          git push -f -u release personal
      
      - name: Purge jsdelivr CDN
        run: |
          for file in $(ls personal/); do
            curl -i "https://purge.jsdelivr.net/gh/${{ github.repository }}@personal/personal/${file}"
          done
