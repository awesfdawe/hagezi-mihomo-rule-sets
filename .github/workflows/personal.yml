name: Personal .mrs builds

on:
  schedule:
    - cron: "0 18 1/4 * *"
  push:
    paths:
      - 'personal/**'
    branches:
      - source
  workflow_dispatch:
  
permissions:
  contents: write

jobs:
  personal:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      
      - name: Set ENV
        run: |
          echo "RELEASE_NAME=$(date +%Y%m%d%H%M)" >> $GITHUB_ENV
        shell: bash

      - name: Install Dependencies
        run: |
          sudo apt update
          sudo apt install -y curl wget git jq
        shell: bash
         
      - name: Create folders
        run: |
          mkdir -p .output
        shell: bash

      - name: Download and install Mihomo
        run: |
          MIHOMO_BIN_URL=$(curl -s -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/MetaCubeX/mihomo/releases/latest | \
            jq -r '.assets[] | select(.name | test("mihomo-linux-amd64-v.*\\.deb$")) | .browser_download_url' | \
            head -n 1)
          wget -q -O ./.output/mihomo-linux-amd64.deb "$MIHOMO_BIN_URL"
          sudo apt install --fix-missing ./.output/mihomo-linux-amd64.deb
        shell: bash
        
      - name: Process personal rules
        run: |
          set -e
          
          # Перебрать все папки в personal/
          for folder in personal/*/; do
            if [ ! -d "$folder" ]; then
              continue
            fi
            
            folder_name=$(basename "$folder")
            echo "Processing folder: $folder_name"
            
            sources_file="$folder/sources.txt"
            addition_file="$folder/addition.list"
            combined_file=".output/${folder_name}_combined.txt"
            output_file="personal/${folder_name}.mrs"
            
            # Создать пустой combined файл
            > "$combined_file"
            
            # Скачать и объединить файлы из sources.txt
            if [ -f "$sources_file" ]; then
              echo "Downloading sources from $sources_file"
              while IFS= read -r url || [ -n "$url" ]; do
                # Очистить URL от невидимых символов и пробелов
                url=$(echo "$url" | tr -d '\r' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
                
                # Пропустить пустые строки и комментарии
                [[ -z "$url" || "$url" =~ ^# ]] && continue
                
                echo "  Downloading: $url"
                
                # Скачать во временный файл
                temp_download=".output/temp_download_${folder_name}.txt"
                
                # Попробовать curl
                if curl -fsSL "$url" -o "$temp_download" 2>/dev/null; then
                  if [ -s "$temp_download" ]; then
                    cat "$temp_download" >> "$combined_file"
                    echo "    Successfully downloaded with curl ($(wc -l < "$temp_download") lines)"
                  else
                    echo "    Downloaded but file is empty"
                  fi
                # Попробовать wget
                elif wget -q -O "$temp_download" "$url" 2>/dev/null; then
                  if [ -s "$temp_download" ]; then
                    cat "$temp_download" >> "$combined_file"
                    echo "    Successfully downloaded with wget ($(wc -l < "$temp_download") lines)"
                  else
                    echo "    Downloaded but file is empty"
                  fi
                else
                  echo "    Failed to download: $url"
                fi
                
                rm -f "$temp_download"
                printf "\n" >> "$combined_file"
              done < "$sources_file"
            else
              echo "Warning: $sources_file not found"
            fi
            
            # Добавить addition.list если существует
            if [ -f "$addition_file" ]; then
              echo "Adding $addition_file"
              cat "$addition_file" >> "$combined_file"
              printf "\n" >> "$combined_file"
            else
              echo "Warning: $addition_file not found"
            fi
            
            # Показать содержимое перед очисткой
            echo "=== Content before cleaning (first 20 lines) ==="
            head -20 "$combined_file" || true
            echo "=== Total lines before cleaning: $(wc -l < "$combined_file") ==="
            
            # Очистить ТОЛЬКО пустые строки
            sed -i '/^[[:space:]]*$/d' "$combined_file"
            
            # Проверить что combined_file не пуст
            if [ ! -s "$combined_file" ]; then
              echo "Error: Combined file is empty for $folder_name"
              continue
            fi
            
            echo "=== Processing $folder_name: $(wc -l < "$combined_file") lines ==="
            
            # Конвертировать в .mrs формат
            echo "Converting to .mrs format"
            if mihomo convert-ruleset domain text "$combined_file" "$output_file"; then
              echo "Successfully created $output_file"
            elif mihomo convert-ruleset ipcidr text "$combined_file" "$output_file"; then
              echo "Successfully created $output_file with ipcidr type"
            else
              echo "Failed to convert $folder_name"
            fi
            
            echo "---"
          done
        shell: bash

      - name: Delete temp files
        run: |
          rm -rf .output
        shell: bash
      
      - name: Push mrs assets to personal branch
        run: |
          git init
          git config --local user.name "github-actions[bot]"
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git checkout --orphan personal
          git rm -rf . 
          git add personal/*.mrs
          git commit -m "${{ env.RELEASE_NAME }}"
          git remote add release "https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}"
          git push -f -u release personal
        shell: bash
      
      - name: Purge jsdelivr CDN
        run: |
          for file in $(ls personal/*.mrs 2>/dev/null); do
            filename=$(basename "$file")
            curl -i "https://purge.jsdelivr.net/gh/${{ github.repository }}@personal/personal/${filename}"
          done
        shell: bash
