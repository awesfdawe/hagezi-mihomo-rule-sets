name: Personal .mrs builds

on:
  schedule:
    - cron: "0 18 1/4 * *"
  push:
    paths:
      - 'personal/**'
    branches:
      - source
  workflow_dispatch:
  
permissions:
  contents: write

jobs:
  personal:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - name: Set ENV
        run: |
          echo "RELEASE_NAME=$(date +%Y%m%d%H%M)" >> $GITHUB_ENV
        shell: bash

      - name: Install Depedencies
        run: |
          sudo apt update
          sudo apt install -y curl wget git jq
        shell: bash
         
      - name: Create folders
        run: |
          mkdir -p .output
          mkdir -p hagezi
        shell: bash

      - name: Download and install Mihomo
        run: |
          MIHOMO_BIN_URL=$(curl -s -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/MetaCubeX/mihomo/releases/latest | \
            jq -r '.assets[] | select(.name | test("mihomo-linux-amd64-v.*\\.deb$")) | .browser_download_url' | \
            head -n 1)
          wget -q -O ./.output/mihomo-linux-amd64.deb "$MIHOMO_BIN_URL"
          sudo apt install --fix-missing ./.output/mihomo-linux-amd64.deb
        shell: bash
        
      - name: Convert to mrs
        run: |
          find personal -type f -name sources.txt | while read source_file; do
            rm -rf .output/*
            subdir=$(dirname "$source_file")
            dir_name=$(basename "$subdir")
            echo "Processing directory: $dir_name"
            
            temp_file=".output/${dir_name}_combined.txt"
            > "$temp_file"
            
            # Загружаем и объединяем все источники
            while IFS= read -r url || [ -n "$url" ]; do
              [[ -z "$url" || "$url" =~ ^[[:space:]]*# ]] && continue
              echo "Downloading $url"
              curl -fsSL "$url" >> "$temp_file" 2>/dev/null || wget -q -O - "$url" >> "$temp_file" || true
              printf "\n" >> "$temp_file"
            done < "$source_file"
            
            # Добавляем дополнительные правила если есть
            addition_file="${subdir}/addition.list"
            if [ -f "$addition_file" ]; then
              cat "$addition_file" >> "$temp_file"
            fi
            
            # Очищаем файл от пустых строк и комментариев
            sed -i '/^[[:space:]]*$/d; /^[[:space:]]*#/d' "$temp_file"
            
            echo "=== Processing $dir_name: $(wc -l < "$temp_file") lines ==="
            
            # Создаём .mrs файл
            out_file="personal/${dir_name}.mrs"
            if [ -s "$temp_file" ]; then
              mihomo convert-ruleset domain text "$temp_file" "$out_file" || {
                echo "Error converting $dir_name, trying alternative format..."
                mihomo convert-ruleset ipcidr text "$temp_file" "$out_file" || echo "Failed to convert $dir_name"
              }
            else
              echo "Warning: $temp_file is empty, skipping conversion"
            fi
          done
        shell: bash

      - name: Delete temp files
        run: |
          rm -rf .output
      
      - name: Push mrs assets to main branch
        run: |
          git init
          git config --local user.name "github-actions[bot]"
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git checkout --orphan personal
          git rm -rf . 
          git add personal/*.mrs
          git commit -m "${{ env.RELEASE_NAME }}"
          git remote add release "https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}"
          git push -f -u release personal
      
      - name: Purge jsdelivr CDN
        run: |
          for file in $(ls personal/); do
            curl -i "https://purge.jsdelivr.net/gh/${{ github.repository }}@personal/personal/${file}"
          done
